<Project>

  <!-- If source generators aren't supported, we just won't register the static one -->
  <PropertyGroup>
    <SourceGeneratorSupported Condition="'$(Language)' == 'C#' AND $(MSBuildShortVersion) &gt;= '16.8'">true</SourceGeneratorSupported>
    <EnableCompileTimeAvatars Condition="'$(EnableCompileTimeAvatars)' == '' AND '$(SourceGeneratorSupported)' == 'true'">true</EnableCompileTimeAvatars>
  </PropertyGroup>

  <PropertyGroup>
    <AvatarAnalyzerDir>$(MSBuildThisFileDirectory)..\..\tools\netstandard2.0</AvatarAnalyzerDir>
  </PropertyGroup>

  <ItemGroup Condition="'$(EnableCompileTimeAvatars)' == 'true'">
    <CompilerVisibleProperty Include="DebugSourceGenerators" />
    <CompilerVisibleProperty Include="DebugAvatarGenerator" />
    <CompilerVisibleProperty Include="SkipCompilerExecution" />
    <CompilerVisibleProperty Include="AvatarAnalyzerDir" />
  </ItemGroup>

  <ItemGroup Condition="'$(EnableCompileTimeAvatars)' == 'true' AND '$(SkipCompilerExecution)' != 'true' AND '$(DesignTimeBuild)' != 'true'">
    <Analyzer Include="$(AvatarAnalyzerDir)\Avatar*.dll" />
  </ItemGroup>

  <ItemGroup Condition="'$(EnableCompileTimeAvatars)' == 'true'">
    <Compile Include="$(MSBuildThisFileDirectory)Avatar.StaticFactory$(DefaultLanguageSourceExtension)"
             Condition="Exists('$(MSBuildThisFileDirectory)Avatar.StaticFactory$(DefaultLanguageSourceExtension)')"
             Visible="false" />
  </ItemGroup>

  <ItemGroup>
    <Compile Update="@(Compile)">
      <!-- Hide Avatar.cs/vb from the project -->
      <Visible Condition="'%(NuGetItemType)' == 'Compile' AND '%(NuGetPackageId)' == 'Avatar'">false</Visible>
    </Compile>
  </ItemGroup>

  <Import Project="Avatar.DynamicProxy.targets"
          Condition="'$(EnableCompileTimeAvatars)' != 'true' AND  Exists('Avatar.DynamicProxy.targets')" />

</Project>
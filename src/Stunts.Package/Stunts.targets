<Project>

  <!-- If source generators aren't supported, we just won't register the static one -->
  <PropertyGroup>
    <SourceGeneratorSupported Condition="'$(Language)' == 'C#' and ('$(LangVersion)' == '9.0' or '$(LangVersion)' == 'Preview') and 
                                          $(MSBuildShortVersion) &gt;= '16.8'">true</SourceGeneratorSupported>
    <RegisterStaticStuntFactory Condition="'$(RegisterStaticStuntFactory)' == '' and 
                                           '$(SourceGeneratorSupported)' == 'true'">true</RegisterStaticStuntFactory>
  </PropertyGroup>

  <PropertyGroup>
    <StuntAnalyzerDir Condition="'$(MSBuildRuntimeType)' == 'Full'">$(MSBuildThisFileDirectory)..\..\tools\net472</StuntAnalyzerDir>
    <StuntAnalyzerDir Condition="'$(MSBuildRuntimeType)' == 'Core'">$(MSBuildThisFileDirectory)..\..\tools\net5.0</StuntAnalyzerDir>
  </PropertyGroup>

  <ItemGroup Condition="'$(RegisterStaticStuntFactory)' == 'true'">
    <CompilerVisibleProperty Include="DebugSourceGenerators" />
    <CompilerVisibleProperty Include="DebugStuntSourceGenerator" />
    <CompilerVisibleProperty Include="SkipCompilerExecution" />
    <CompilerVisibleProperty Include="EmitStuntSource" />
    <CompilerVisibleProperty Include="StuntAnalyzerDir" />
  </ItemGroup>

  <ItemGroup Condition="'$(RegisterStaticStuntFactory)' == 'true' and '$(MSBuildRuntimeType)' == 'Full' and '$(SkipCompilerExecution)' != 'true' and '$(DesignTimeBuild)' != 'true'">
    <Analyzer Include="$(MSBuildThisFileDirectory)..\..\tools\net472\Stunts*.dll" />
  </ItemGroup>

  <ItemGroup Condition="'$(SourceGeneratorSupported)' == 'true' and '$(RegisterStaticStuntFactory)' != 'false' and '$(MSBuildRuntimeType)' == 'Core' and '$(SkipCompilerExecution)' != 'true' and '$(DesignTimeBuild)' != 'true'">
    <Analyzer Include="$(MSBuildThisFileDirectory)..\..\tools\net5.0\Stunts*.dll" />
  </ItemGroup>

  <ItemGroup Condition="'$(RegisterStaticStuntFactory)' == 'true'">
    <Compile Include="$(MSBuildThisFileDirectory)Stunt.StaticFactory$(DefaultLanguageSourceExtension)"
             Condition="Exists('$(MSBuildThisFileDirectory)Stunt.StaticFactory$(DefaultLanguageSourceExtension)')"
             Visible="false" />
  </ItemGroup>

  <ItemGroup>
    <Compile Update="@(Compile)">
      <!-- Hide Stunts.cs/vb from the project -->
      <Visible Condition="'%(NuGetItemType)' == 'Compile' and '%(NuGetPackageId)' == 'Stunts'">false</Visible>
    </Compile>
  </ItemGroup>

  <Import Project="Stunts.DynamicProxy.targets"
          Condition="'$(RegisterStaticStuntFactory)' != 'true' and  Exists('Stunts.DynamicProxy.targets')" />

</Project>
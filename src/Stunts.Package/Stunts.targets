<Project>

  <!-- If source generators aren't supported, we just won't register the static one -->
  <PropertyGroup Condition="'$(Language)' == 'C#' and ('$(LangVersion)' == '9.0' or '$(LangVersion)' == 'Preview') and 
                             $(MSBuildShortVersion) &gt;= '16.8'">
    <SourceGeneratorSupported>true</SourceGeneratorSupported>
  </PropertyGroup>

  <PropertyGroup>
    <StuntAnalyzerDir Condition="'$(MSBuildRuntimeType)' == 'Full'">$(MSBuildThisFileDirectory)..\..\tools\net472</StuntAnalyzerDir>
    <StuntAnalyzerDir Condition="'$(MSBuildRuntimeType)' == 'Core'">$(MSBuildThisFileDirectory)..\..\tools\net5.0</StuntAnalyzerDir>
  </PropertyGroup>

  <ItemGroup Condition="'$(SourceGeneratorSupported)' == 'true'">
    <CompilerVisibleProperty Include="DebugSourceGenerators" />
    <CompilerVisibleProperty Include="DebugStuntSourceGenerator" />
    <CompilerVisibleProperty Include="SkipCompilerExecution" />
    <CompilerVisibleProperty Include="EmitStuntSource" />
    <CompilerVisibleProperty Include="StuntAnalyzerDir" />
  </ItemGroup>

  <ItemGroup Condition="'$(SourceGeneratorSupported)' == 'true' and '$(MSBuildRuntimeType)' == 'Full' and '$(SkipCompilerExecution)' != 'true' and '$(DesignTimeBuild)' != 'true'">
    <Analyzer Include="$(MSBuildThisFileDirectory)..\..\tools\net472\Stunts*.dll" />
  </ItemGroup>

  <ItemGroup Condition="'$(SourceGeneratorSupported)' == 'true' and '$(MSBuildRuntimeType)' == 'Core' and '$(SkipCompilerExecution)' != 'true' and '$(DesignTimeBuild)' != 'true'">
    <Analyzer Include="$(MSBuildThisFileDirectory)..\..\tools\net5.0\Stunts*.dll" />
  </ItemGroup>

  <ItemGroup Condition="'$(SourceGeneratorSupported)' == 'true' and '$(RegisterStaticStuntFactory)' != 'false'">
    <StuntFactory Include="$(StaticStuntFactory)" PackageId="Stunts" />
  </ItemGroup>

  <ItemGroup>
    <Compile Update="@(Compile)">
      <!-- Hide Stunts.cs/vb from the project -->
      <Visible Condition="'%(NuGetItemType)' == 'Compile' and '%(NuGetPackageId)' == 'Stunts'">false</Visible>
    </Compile>
  </ItemGroup>

  <Target Name="GetStuntFactoryAttributes" BeforeTargets="GetAssemblyAttributes" Returns="@(StuntFactory)">
    <ItemGroup>
      <!-- This adds all factories unconditionally, since the specific factories 
           will actually check for duplicates and warn as needed. -->
      <AssemblyAttribute Include="Stunts.StuntFactoryAttribute" Condition="'%(StuntFactory.Identity)' != ''">
        <_Parameter1>%(StuntFactory.Identity)</_Parameter1>
        <_Parameter2>%(StuntFactory.PackageId)</_Parameter2>
      </AssemblyAttribute>
    </ItemGroup>
  </Target>

  <Target Name="EnsureStuntFactory" BeforeTargets="BeforeCompile;CoreCompile">
    <PropertyGroup>
      <StuntFactories>@(StuntFactory -> Count())</StuntFactories>
    </PropertyGroup>
    <ItemGroup>
      <StuntFactoryPackage Include="@(StuntFactory -> '%(PackageId)')" />
    </ItemGroup>

    <Warning Code="STB001" Condition="$(StuntFactories) &gt; '1'"
       Text="More than one stunt factory is registered in the current project. Only the first one will be used unless explicitly set as StuntFactory.Default. Packages providing factories: @(StuntFactoryPackage, ', ')." />

    <Warning Code="STB002" Condition="'@(StuntFactory)' == '' and '$(SourceGeneratorSupported)' != 'true' and '$(RegisterStaticStuntFactory)' != 'false'"
             Text="Built-in stunt factory requires C# 9.0. Please install Stunt.DynamicFactory package as an alternative." />
  </Target>

</Project>